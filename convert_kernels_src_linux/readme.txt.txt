= GENERAL INFO =

This folder contains C source code that compiles into an executable
to convert legacy fixed kernels from ASCII format to binary format
with 64-bit floating point data.

The sources come with test data for spheres and spheroids. The corresponding
fixed kernels were generated by S. Korkin under Windows using the original
FORTRAN package as described in O. Dubovik et al., JGR, 2006
(https://doi.org/10.1029/2005JD006619).

The source code provided herein was tested under both Windows and Linux.

= WARNING =

Due to differences in ASCII format between Linux and Windows, the Linux user
may wish to open and re-save all ASCII files provided in ./KERNEL_n22_fix/
(after they have been unzipped) to avoid strange errors (e.g., segmentation
faults) or incorrect numerical results in the output.


= STEP-BY-STEP INSTRUCTIONS =

All commands are executed from ./convert_kernels

1. Go to ./KERNEL_n22_fix/ and UNZIP the 12 zipped files. Each file is
   approximately 30 MB, which exceeds GitHub's single-file size limit.

2. Open const_param_spheroids.h and make sure that line 17:
   rootdir[path_len_max] = "./KERNEL_n22_fix/"
   points to the folder containing the ASCII files. The *.bin files
   will also be placed there. Amend as appropriate.

   The const_param_spheroids.h is same as this
   https://github.com/korkins/spheroids/blob/main/src/const_param_spheroids.h
   (except for line 17: rootdir[path_len_max]), duplicated for convenience.
   
3. Make the 'build' file executable: 
   $ chmod u+x build

4. Run it to compile the code: 
   $ ./build

5. After compilation, an executable 'conker' should appear.
   Run it (optionally with timing):
   $ time ./conker

6. In about 10 seconds, a few numbers will be printed on the screen
   (see SCREENSHOT below).

7. Fourteen new *.bin files should appear in ./KERNEL_n22_fix/
   (from step 1 above).

8. Run the Python script:
   $ python compare_bins.py
   (Update the path to ./KERNEL_n22_fix/ in the script if needed.)

9. The Python script compares the freshly generated *.bin files
   with those in 
   https://github.com/korkins/spheroids/tree/main/kernels_fix_bin
   (assumed benchmark). For convenience, these *.bin files have
   been copied to ./github_bins_bmrk.  
   If all is correct, the maximum absolute difference should be all zeros.


Rkernel1.11.fix.bin: max abs diff = 0.0e+00
Rkernel1.11_s.fix.bin: max abs diff = 0.0e+00
Rkernel1.12.fix.bin: max abs diff = 0.0e+00
Rkernel1.12_s.fix.bin: max abs diff = 0.0e+00
Rkernel1.22.fix.bin: max abs diff = 0.0e+00
Rkernel1.22_s.fix.bin: max abs diff = 0.0e+00
Rkernel1.33.fix.bin: max abs diff = 0.0e+00
Rkernel1.33_s.fix.bin: max abs diff = 0.0e+00
Rkernel1.34.fix.bin: max abs diff = 0.0e+00
Rkernel1.34_s.fix.bin: max abs diff = 0.0e+00
Rkernel1.44.fix.bin: max abs diff = 0.0e+00
Rkernel1.44_s.fix.bin: max abs diff = 0.0e+00
Rkext1.fix.bin: max abs diff = 0.0e+00
Rkext1_s.fix.bin: max abs diff = 0.0e+00

This indicates that the *.bin files located in ./github_bins_bmrk, which contain the same data as 
those at https://github.com/korkins/spheroids/tree/main/kernels_fix_bin, correspond to the original 
fixed kernels in ASCII format located in ./KERNEL_n22_fix/.


= SCREENSHOT =

While running, the code confirms that it has read the files successfully and prints out a few numbers 
for visual inspection (basically to show they are not NaNs, Infs, or some ridiculous value).  

As a self-test, the code reads back the *.bin files and prints a few numbers from them 
alongside the corresponding numbers from the ASCII files.

read ASCII - runtime:    9.273s
   ufext[0] = 4.504931e-06, ufext[nx-1] = 0.000000e+00
   ufabs[0] = 0.000000e+00, ufabs[nx-1] = 8.007918e-06
    uf11[0] = 1.225278e-07,  uf11[nx-1] = 0.000000e+00
    uf22[0] = 1.220789e-07,  uf22[nx-1] = 0.000000e+00
    uf33[0] = 1.220789e-07,  uf33[nx-1] = 0.000000e+00
    uf44[0] = 1.216299e-07,  uf44[nx-1] = 0.000000e+00
    uf12[0] = 0.000000e+00,  uf12[nx-1] = 0.000000e+00
    uf34[0] = 0.000000e+00,  uf34[nx-1] = 0.000000e+00

(in write_Rkext_fix_bin) bin saved: ./KERNEL_n22_fix/Rkext1_s.fix.bin
(in write_Rkext_fix_bin) bin saved: ./KERNEL_n22_fix/Rkext1.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.11_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.11.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.22_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.22.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.33_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.33.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.44_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.44.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.12_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.12.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.34_s.fix.bin
(in write_Rkernel_fix_bin) bin saved: ./KERNEL_n22_fix/Rkernel1.34.fix.bin
read BIN - runtime:    0.114s
   tfext[0] = 4.504931e-06, tfext[nx-1] = 0.000000e+00
   tfabs[0] = 0.000000e+00, tfabs[nx-1] = 8.007918e-06
    tf11[0] = 1.225278e-07,  tf11[nx-1] = 2.089536e-05
    tf22[0] = 1.220789e-07,  tf22[nx-1] = 2.089536e-05
    tf33[0] = 1.220789e-07,  tf33[nx-1] = 2.078170e-05
    tf44[0] = 1.216299e-07,  tf44[nx-1] = 2.078170e-05
    tf12[0] = 0.000000e+00,  tf12[nx-1] = -1.333206e-06
    tf34[0] = 0.000000e+00,  tf34[nx-1] = 3.308207e-07

TEST: nodes and values::
refre[9] = 1.4650000e+00
refim[10] = 6.9474770e-02
rgrid_fix[11] = 6.5603670e-02
sangl_fix[12] =  12.0
 ix0 = 4941
 ufext_mie[ix0] = 1.539523e-04, tfext_mie[ix0] = 1.539523e-04
 ufabs_mie[ix0] = 0.000000e+00, tfabs_mie[ix0] = 0.000000e+00
 ufext_srd[ix0] = 1.529323e-04, tfext_srd[ix0] = 1.529323e-04
 ufabs_srd[ix0] = 0.000000e+00, tfabs_srd[ix0] = 0.000000e+00
 iy0 = 894333,  ix0 = 139581
 uf11_mie[iy0] =   2.845546e-03, tf11_mie[ix0] =   2.845546e-03
 uf11_srd[iy0] =   2.838761e-03, tf11_srd[ix0] =   2.838761e-03
 uf22_mie[iy0] =   2.845546e-03, tf22_mie[ix0] =   2.845546e-03
 uf22_srd[iy0] =   2.800157e-03, tf22_srd[ix0] =   2.800157e-03
 uf33_mie[iy0] =   2.842580e-03, tf33_mie[ix0] =   2.842580e-03
 uf33_srd[iy0] =   2.796650e-03, tf33_srd[ix0] =   2.796650e-03
 uf44_mie[iy0] =   2.842580e-03, tf44_mie[ix0] =   2.842580e-03
 uf44_srd[iy0] =   2.758763e-03, tf44_srd[ix0] =   2.758763e-03
 uf12_mie[iy0] =  -1.295603e-04, tf12_mie[ix0] =  -1.295603e-04
 uf12_srd[iy0] =  -1.397517e-04, tf12_srd[ix0] =  -1.397517e-04
 uf34_mie[iy0] =  -1.633402e-06, tf34_mie[ix0] =  -1.633402e-06
 uf34_srd[iy0] =  -1.189707e-07, tf34_srd[ix0] =  -1.189707e-07
done!

= EOF =

